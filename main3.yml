version: 0.2

runs-on: ubuntu-latest

env:
   AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
   AWS_S3_ARTIFACT: ${{ secrets.AWS_S3_ARTIFACT }}
   AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
   AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

proxy:
   upload-artifacts: yes
   logs: yes

phases:
   install:
      runtime-versions:
         nodejs: 18
      commands:
         name: Install Node.js
         uses: actions/setup-node@v3
         with:
            node-version: 18

   pre_build:
      run-as:
      commands:
         - echo "Installing dependencies - source npm dependencies..."
         - npm install
         - aws --version

   build:
      commands:
         - echo "Build started on $(date)"
         - echo "Running first test codes"
         - echo "Compiling Node.js code"
         - npm run build
         - echo "Build finished. Now moving to S3"

   post_build:
      commands:
         - echo "Build completed on $(date)"
         - ls
         - pwd
         - aws s3 sync build/ s3://${{ secrets.AWS_S3_ARTIFACT }} --acl public-read

artifacts:
   files:
      - "build/*"
